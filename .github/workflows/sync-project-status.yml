name: Sync Labels to Project Status

on:
  issues:
    types: [labeled, unlabeled]

env:
  PROJECT_NUMBER: 15  # sfis-demo Compliance Pipeline (repo-level)
  FIELD_NAME: Stage  # Change this to your custom field name

jobs:
  sync-status:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      repository-projects: write
    steps:
      - name: Sync label to project field
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const label = context.payload.label?.name;
            const issueNodeId = context.payload.issue.node_id;
            
            // Map labels to field option values
            const labelToStatus = {
              'ready': 'Ready',
              'parsing': 'Parsing', 
              'querying': 'Querying',
              'complete': 'Complete'
            };
            
            const newStatus = labelToStatus[label];
            if (!newStatus) {
              console.log(`Label "${label}" not in mapping, skipping`);
              return;
            }
            
            console.log(`Syncing label "${label}" -> Status: "${newStatus}"`);
            
            // Get the project (repo-level project)
            const projectQuery = `
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  projectV2(number: $number) {
                    id
                    field(name: "Stage") {
                      ... on ProjectV2SingleSelectField {
                        id
                        options { id name }
                      }
                    }
                  }
                }
              }
            `;
            
            const projectResult = await github.graphql(projectQuery, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              number: parseInt(process.env.PROJECT_NUMBER)
            });
            
            const project = projectResult.repository.projectV2;
            const field = project.field;
            const option = field.options.find(o => o.name === newStatus);
            
            if (!option) {
              console.log(`Option "${newStatus}" not found in field`);
              return;
            }
            
            // Find the project item for this issue
            const itemQuery = `
              query($projectId: ID!, $issueId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    items(first: 100) {
                      nodes {
                        id
                        content { ... on Issue { id } }
                      }
                    }
                  }
                }
              }
            `;
            
            const itemResult = await github.graphql(itemQuery, {
              projectId: project.id,
              issueId: issueNodeId
            });
            
            const item = itemResult.node.items.nodes.find(
              i => i.content?.id === issueNodeId
            );
            
            if (!item) {
              console.log('Issue not found in project, adding it first...');
              
              // Add issue to project
              const addMutation = `
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
                    item { id }
                  }
                }
              `;
              
              const addResult = await github.graphql(addMutation, {
                projectId: project.id,
                contentId: issueNodeId
              });
              
              var itemId = addResult.addProjectV2ItemById.item.id;
            } else {
              var itemId = item.id;
            }
            
            // Update the field value
            const updateMutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: { singleSelectOptionId: $optionId }
                }) {
                  projectV2Item { id }
                }
              }
            `;
            
            await github.graphql(updateMutation, {
              projectId: project.id,
              itemId: itemId,
              fieldId: field.id,
              optionId: option.id
            });
            
            console.log(`âœ… Updated issue to Stage: ${newStatus}`);
